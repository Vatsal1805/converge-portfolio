import gsap from "gsap"
import { SplitText } from "gsap/SplitText"
import { ScrollTrigger } from "gsap/ScrollTrigger"
import { useGSAP } from "@gsap/react"
import { useRef } from "react"

// Register plugins once
gsap.registerPlugin(SplitText, ScrollTrigger, useGSAP)

interface TextBlockAnimationProps {
    children: React.ReactNode
    animateOnScroll?: boolean
    delay?: number
    blockColor?: string
    stagger?: number
    duration?: number
}

export default function TextBlockAnimation({
    children,
    animateOnScroll = true,
    delay = 0,
    blockColor = "#fff",
    stagger = 0.05,
    duration = 0.45,
}: TextBlockAnimationProps) {
    const containerRef = useRef<HTMLDivElement>(null)

    useGSAP(() => {
        if (!containerRef.current) return

        const split = new SplitText(containerRef.current, {
            type: "lines",
            linesClass: "split-line-parent",
        })

        const lines = split.lines
        const blocks: HTMLDivElement[] = []

        lines.forEach((line: Element) => {
            const wrapper = document.createElement("div")
            wrapper.style.position = "relative"
            wrapper.style.display = "block"
            wrapper.style.overflow = "hidden"

            const block = document.createElement("div")
            block.style.position = "absolute"
            block.style.top = "0"
            block.style.left = "0"
            block.style.width = "100%"
            block.style.height = "100%"
            block.style.backgroundColor = blockColor
            block.style.opacity = "0.85"
            block.style.zIndex = "2"
            block.style.transform = "scaleX(0)"
            block.style.transformOrigin = "left center"

            line.parentNode!.insertBefore(wrapper, line)
            wrapper.appendChild(line)
            wrapper.appendChild(block)

            gsap.set(line, { opacity: 0 })
            blocks.push(block)
        })

        const tl = gsap.timeline({
            defaults: { ease: "power2.out" },
            scrollTrigger: animateOnScroll
                ? {
                    trigger: containerRef.current,
                    start: "top 78%",
                    toggleActions: "play none none none",
                }
                : undefined,
            delay,
        })

        tl.to(blocks, {
            scaleX: 1,
            duration,
            stagger,
            transformOrigin: "left center",
        })
            .set(lines, { opacity: 1, stagger }, `<${duration * 0.6}`)
            .to(blocks, {
                scaleX: 0,
                duration,
                stagger,
                transformOrigin: "right center",
            }, `<${duration * 0.4}`)

        return () => {
            split.revert()
        }
    }, {
        scope: containerRef,
        dependencies: [animateOnScroll, delay, blockColor, stagger, duration],
    })

    return (
        <div ref={containerRef} style={{ position: "relative" }}>
            {children}
        </div>
    )
}
